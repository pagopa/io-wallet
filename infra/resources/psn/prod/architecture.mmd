---
title: "IT-Wallet Architecture on PSN (Milestone 2)"
config:
  theme: mc
  fontFamily: Gill Sans, sans-serif;
---
graph LR
    subgraph PagoPA["PagoPA"]

        subgraph VNet["VNet (ItalyNorth)"]
            AppIO["`App IO
              (Backend)`"]
            HubAppGwPEP["io-p-itn-psn-agw-pep-01"]
            HubAppGwPrivateDNS["internal.api.wallet.io.pagopa.it"]
        end
        subgraph FrontDoor["Global"]
          IOWebCDN["`IO Web
            (Static Website)`"]
        end
        CDNDNS["wallet.io.pagopa.it"]
    end

    subgraph PSN

        subgraph Hub["Hub"]
            subgraph HubAppGwWaf["`Application Gateway + WAF
              Public + Private IPs`"]
              HubWAF
              HubAppGw
            end
            AppGwPublicDNS["api.wallet.io.pagopa.it"]
            AppGwPrivateLink["private-link-01"]

        end

        subgraph Spoke["Spoke"]
            WalletInfraKeyVault["iw-p-itn-infra-kv-01"]

            subgraph PSNGlobal["Global"]
              ITWalletCDN["iw-p-itn-cdn-fde-01"]
              subgraph WalletCDNSA["iwpitncdnst01"]
                ContainerSpid[spid-hub-login]
                ContainerPdnd[pdnd]
                ContainerExchange[exchange]
                ContainerWellKnown[well-known]
                ContainerSpid ~~~ ContainerPdnd ~~~ ContainerExchange ~~~ ContainerWellKnown
              end
            end

            subgraph VNetWallet["pagopa-Prod-ITWallet-spoke-italynorth"]
              subgraph GHRunnerRG["iw-p-itn-github-runner-rg-01"]
                  GitHubRunner["iw-p-itn-io-wallet-caj-01"]
              end
              SpokeAPIM["iw-p-itn-apps-apim-01"]
              WalletFunctionUserPep["iw-p-itn-user-func-pep-01"]
              WalletFunctionUser[iw-p-itn-user-func-01]
              WalletFunctionSupportPep["iw-p-itn-support-func-pep-01"]
              WalletFunctionSupport[iw-p-itn-support-func-01]
              WalletAppsKeyVaultPep["iw-p-itn-apps-kv-pep-01"]
              WalletAppsKeyVault["iw-p-itn-apps-kv-01"]
              WalletCosmosPep["iw-p-itn-apps-cosno-pep-01"]
              WalletCosmos["iw-p-itn-apps-cosno-01"]
              WalletCMKKey["iw-p-itn-data-cmk-id-01"]
              WalletSAPep["iw-p-itn-apps-x-pep-01"]

              subgraph WalletSA["iwpitnappsst01"]
                  direction TB
                  QueueEmail["creation-email-queue-01"]
                  QueueRevocationEmail["revocation-email-queue-01"]
                  QueueEmail ~~~ QueueRevocationEmail
              end
            end
        end

        APIMDNS["apim.internal.wallet.io.pagopa.it"]
    end

    subgraph GitHub["GitHub"]
        GitHubRepo
    end

    subgraph ThirdParties["Third Parties"]
        RelyingParty["Relying Party"]
        CredentialIssuer["Credential Issuer"]
    end

    HubAppGwWaf -.-> WalletInfraKeyVault
    ITWalletCDN -.-> WalletInfraKeyVault

    ITWalletCDN --> WalletCDNSA
    AppIO --> HubAppGwPEP --> HubAppGwPrivateDNS --> AppGwPrivateLink --> HubAppGwWaf
    IOWebCDN --> AppGwPublicDNS --> HubAppGwWaf

    Hub --> APIMDNS --> SpokeAPIM
    SpokeAPIM --> WalletFunctionUserPep --> WalletFunctionUser
    SpokeAPIM --> WalletFunctionSupportPep --> WalletFunctionSupport --> WalletCosmosPep

    WalletFunctionUser --> WalletCosmosPep --> WalletCosmos
    WalletFunctionUser --> WalletSAPep --> WalletSA
    WalletFunctionUser --> WalletAppsKeyVaultPep --> WalletAppsKeyVault

    WalletSA -.-> WalletCMKKey
    WalletCosmos -.-> WalletCMKKey

    GitHubRunner --> GitHubRepo

    ThirdParties --> CDNDNS --> ITWalletCDN

    ITWalletCDN@{ icon: "azure:front-door-and-cdn-profiles", pos: "b" }
    IOWebCDN@{ icon: "azure:front-door-and-cdn-profiles", pos: "b" }
    HubWAF@{ icon: "azure:web-application-firewall-policieswaf", pos: "b" }
    HubAppGw@{ icon: "azure:application-gateways", pos: "b" }
    HubAppGwPEP@{ icon: "azure:private-endpoints", pos: "b" }
    AppGwPrivateLink@{ icon: "azure:private-link", pos: "b" }
    HubAppGwPrivateDNS@{icon: "azure:dns-zones", pos: "b"}
    CDNDNS@{icon: "azure:dns-zones", pos: "b"}
    APIMDNS@{icon: "azure:dns-zones", pos: "b"}
    AppGwPublicDNS@{icon: "azure:dns-zones", pos: "b"}
    SpokeAPIM@{ icon: "azure:api-management-services", pos: "b" }
    AppIO@{ icon: "azure:app-service-plans", pos: "b" }
    WalletFunctionUserPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletFunctionUser@{ icon: "azure:function-apps", pos: "b" }
    WalletFunctionSupportPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletFunctionSupport@{ icon: "azure:function-apps", pos: "b" }
    WalletCosmosPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletCosmos@{ icon: "azure:azure-cosmos-db", pos: "b" }
    WalletAppsKeyVault@{ icon: "azure:key-vaults", pos: "b" }
    WalletAppsKeyVaultPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletInfraKeyVault@{ icon: "azure:key-vaults", pos: "b" }
    WalletCMKKey@{ icon: "azure:managed-identities", pos: "b" }
    ContainerSpid@{ icon: "azure:storage-container", pos: "b" }
    ContainerPdnd@{ icon: "azure:storage-container", pos: "b" }
    ContainerExchange@{ icon: "azure:storage-container", pos: "b" }
    ContainerWellKnown@{ icon: "azure:storage-container", pos: "b" }
    GitHubRunner@{ icon: "azure:worker-container-app", pos: "b" }
    GitHubRepo@{ icon: "aws:res-git-repository", pos: "b" }
    WalletSAPep@{ icon: "azure:private-endpoints", pos: "b" }
    QueueEmail@{ icon: "azure:storage-queue"}
    QueueRevocationEmail@{ icon: "azure:storage-queue"}

    classDef macroBlock stroke-dasharray: 5 5, stroke-width:3px
    classDef subBlock stroke-dasharray: 5 5, stroke-width:2px
    classDef thirdPartiesClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:1px
    classDef pagoPAStyle fill:#e8f4fd,stroke:#3498db,stroke-width:2px
    classDef psnStyle fill:#edf7f6,stroke:#16a085,stroke-width:2px
    classDef psnGlobalStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef hubStyle fill:#fff4e6,stroke:#d68910,stroke-width:1px
    classDef spokeStyle fill:#f4ecf7,stroke:#8e44ad,stroke-width:1px
    classDef disabledStyle fill:#f5f5f5,stroke:#d3d3d3,stroke-width:1px,stroke-dasharray: 3 3,color:#999999,opacity:0.6

    class PagoPA pagoPAStyle
    class PSN psnStyle
    class PSNGlobal psnGlobalStyle
    class Hub,HubAppGwWaf hubStyle
    class Spoke spokeStyle
    class VNet,FrontDoor pagoPAStyle
    class ITWalletRG,VNetWallet,GHRunnerRG,WalletSA,WalletCDNSA spokeStyle

    class RelyingParty thirdPartiesClass
    class CredentialIssuer thirdPartiesClass
