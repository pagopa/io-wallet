---
title: "IT-Wallet Architecture on PSN (Milestone 2)"
config:
  theme: mc
  fontFamily: Gill Sans, sans-serif;
---
graph LR
    subgraph PagoPA["PagoPA"]

        subgraph VNet["VNet (ItalyNorth)"]
            AppIO["`App IO
              (Backend)`"]
            HubAppGwPEP["io-p-itn-psn-agw-pep-01"]
            HubAppGwPrivateDNS["psn.internal.io.pagopa.it"]
        end
        subgraph FrontDoor["Global"]
          ITWalletCDN["`Front Door
            (CDN)`"]
          CDNID["`User-Assigned
            Managed Identity`"]

          IOWebCDN["`IO Web
            (Static Website)`"]
        end
    end

    subgraph PSN
        PSNEnterpriseApp["Enterprise App"]

        subgraph Hub["Hub"]

            subgraph HubAppGwWaf["`Application Gateway + WAF
              Public + Private IPs`"]
              HubWAF
              HubAppGw
            end

        end

        subgraph Spoke["Spoke"]
            subgraph VNetWallet["pagopa-Prod-ITWallet-spoke-italynorth"]

                subgraph GHRunnerRG["io-p-itn-wallet-runner-rg-01"]
                    GitHubRunner[io-p-itn-github-caj-01]
                end
                subgraph ITWalletRG["iw-p-itn-wallet-rg-01"]
                HubAPIM["io-p-itn-apim-01"]
                WalletFunctionUserPep["iw-p-itn-user-func-pep-01"]
                WalletFunctionUser[iw-p-itn-user-func-01]
                WalletFunctionSupportPep["iw-p-itn-support-func-pep-01"]
                WalletFunctionSupport[iw-p-itn-support-func-01]
                WalletAppsKeyVaultPep["iw-p-itn-apps-kv-pep-01"]
                WalletAppsKeyVault["iw-p-itn-apps-kv-01"]
                WalletCDNKeyVault["iw-p-itn-cdn-kv-01"]
                WalletCosmosPep["iw-p-itn-apps-cosno-pep-01"]
                WalletCosmos["iw-p-itn-apps-cosno-01"]
                WalletCMKKey["iw-p-itn-data-cmk-id-01"]

                subgraph WalletCDNSA["iopitnwalletcdnst01"]
                    direction TB
                    ContainerSpid[spid-hub-login]
                    ContainerPdnd[pdnd]
                    ContainerExchange[exchange]
                    ContainerWellKnown[well-known]
                    ContainerSpid ~~~ ContainerPdnd ~~~ ContainerExchange ~~~ ContainerWellKnown
                end

                WalletSAPep["iw-p-itn-apps-x-pep-01"]

                subgraph WalletSA["iwpitnappsst01"]
                    direction TB
                    QueueEmail["creation-email-queue-01"]
                    QueueRevocationEmail["revocation-email-queue-01"]
                    QueueEmail ~~~ QueueRevocationEmail
                end
              end
            end
        end

    end

    subgraph GitHub["GitHub"]
        GitHubRepo
    end

    subgraph ThirdParties["Third Parties"]
        RelyingParty["Relying Party"]
        CredentialIssuer["Credential Issuer"]
    end

    ITWalletCDN --> CDNID --> PSNEnterpriseApp --> WalletCDNSA
    AppIO --> HubAppGwPEP --> HubAppGwPrivateDNS --> HubAppGwWaf
    IOWebCDN --> HubAppGwWaf

    Hub --> HubAPIM
    HubAPIM --> WalletFunctionUserPep --> WalletFunctionUser
    HubAPIM --> WalletFunctionSupportPep --> WalletFunctionSupport --> WalletCosmosPep

    WalletFunctionUser --> WalletCosmosPep --> WalletCosmos
    WalletFunctionUser --> WalletSAPep --> WalletSA
    WalletFunctionUser --> WalletAppsKeyVaultPep --> WalletAppsKeyVault

    WalletSA --> WalletCMKKey
    WalletCosmos --> WalletCMKKey

    GitHubRunner --> GitHubRepo

    ThirdParties --> ITWalletCDN
    PSNEnterpriseApp@{ icon: "azure:enterprise-applications", pos: "b" }
    ITWalletCDN@{ icon: "azure:front-door-and-cdn-profiles", pos: "b" }
    IOWebCDN@{ icon: "azure:front-door-and-cdn-profiles", pos: "b" }
    HubWAF@{ icon: "azure:web-application-firewall-policieswaf", pos: "b" }
    HubAppGw@{ icon: "azure:application-gateways", pos: "b" }
    HubAppGwPEP@{ icon: "azure:private-link", pos: "b" }
    HubAppGwPrivateDNS@{icon: "azure:dns-zones", pos: "b"}
    HubAPIM@{ icon: "azure:api-management-services", pos: "b" }
    AppIO@{ icon: "azure:app-service-plans", pos: "b" }
    WalletFunctionUserPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletFunctionUser@{ icon: "azure:function-apps", pos: "b" }
    WalletFunctionSupportPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletFunctionSupport@{ icon: "azure:function-apps", pos: "b" }
    CDNID@{ icon: "azure:managed-identities", pos: "b" }
    WalletCosmosPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletCosmos@{ icon: "azure:azure-cosmos-db", pos: "b" }
    WalletAppsKeyVault@{ icon: "azure:key-vaults", pos: "b" }
    WalletAppsKeyVaultPep@{ icon: "azure:private-endpoints", pos: "b" }
    WalletCDNKeyVault@{ icon: "azure:key-vaults", pos: "b" }
    WalletCMKKey@{ icon: "azure:managed-identities", pos: "b" }
    ContainerSpid@{ icon: "azure:storage-container", pos: "b" }
    ContainerPdnd@{ icon: "azure:storage-container", pos: "b" }
    ContainerExchange@{ icon: "azure:storage-container", pos: "b" }
    ContainerWellKnown@{ icon: "azure:storage-container", pos: "b" }
    GitHubRunner@{ icon: "azure:worker-container-app", pos: "b" }
    GitHubRepo@{ icon: "aws:res-git-repository", pos: "b" }
    WalletSAPep@{ icon: "azure:private-endpoints", pos: "b" }
    QueueEmail@{ icon: "azure:storage-queue"}
    QueueRevocationEmail@{ icon: "azure:storage-queue"}

    classDef macroBlock stroke-dasharray: 5 5, stroke-width:3px
    classDef subBlock stroke-dasharray: 5 5, stroke-width:2px
    classDef thirdPartiesClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:1px
    classDef pagoPAStyle fill:#e8f4fd,stroke:#3498db,stroke-width:2px
    classDef psnStyle fill:#edf7f6,stroke:#16a085,stroke-width:2px
    classDef hubStyle fill:#fff4e6,stroke:#d68910,stroke-width:1px
    classDef spokeStyle fill:#f4ecf7,stroke:#8e44ad,stroke-width:1px
    classDef disabledStyle fill:#f5f5f5,stroke:#d3d3d3,stroke-width:1px,stroke-dasharray: 3 3,color:#999999,opacity:0.6

    linkStyle 4,5,6,26 stroke:#f39c12,stroke-width:2px

    class PagoPA pagoPAStyle
    class PSN psnStyle
    class Hub,HubAppGwWaf hubStyle
    class Spoke spokeStyle
    class VNet,FrontDoor pagoPAStyle
    class ITWalletRG,VNetWallet,GHRunnerRG,WalletSA,WalletCDNSA spokeStyle

    class RelyingParty thirdPartiesClass
    class CredentialIssuer thirdPartiesClass
    class ITWalletCDN,CDNID,PSNEnterpriseApp,HubAPIM,GitHubRunner,WalletCDNSA,ContainerExchange,ContainerWellKnown,ContainerPdnd,ContainerSpid disabledStyle
